{{ 'portfolio-showcase.css' | asset_url | stylesheet_tag }}

<div class="portfolio-showcase" data-section-id="{{ section.id }}">
  <div class="page-width">
    
    {% comment %} Section Header {% endcomment %}
    {% if section.settings.heading != blank or section.settings.subheading != blank %}
      <div class="portfolio-showcase__header">
        {% if section.settings.heading != blank %}
          <h2 class="portfolio-showcase__title">{{ section.settings.heading }}</h2>
        {% endif %}
        {% if section.settings.subheading != blank %}
          <div class="portfolio-showcase__subtitle">{{ section.settings.subheading }}</div>
        {% endif %}
      </div>
    {% endif %}

    {% comment %} Collection Type Filter {% endcomment %}
    {% if section.settings.show_collection_filter %}
      <div class="portfolio-showcase__filter">
        <div class="portfolio-showcase__filter-tabs">
          <button class="portfolio-showcase__filter-tab active" data-filter="products">
            <span class="portfolio-showcase__filter-icon">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 2L3 7V18H8V13H12V18H17V7L10 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="portfolio-showcase__filter-text">Our Products</span>
          </button>
          <button class="portfolio-showcase__filter-tab" data-filter="factory">
            <span class="portfolio-showcase__filter-icon">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M3 17H17V9L10 3L3 9V17Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="portfolio-showcase__filter-text">Our Factory</span>
          </button>
          <button class="portfolio-showcase__filter-tab" data-filter="team">
            <span class="portfolio-showcase__filter-icon">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" stroke="currentColor" stroke-width="1.5"/>
                <path d="M12 14C8.13401 14 5 17.134 5 21H19C19 17.134 15.866 14 12 14Z" stroke="currentColor" stroke-width="1.5"/>
              </svg>
            </span>
            <span class="portfolio-showcase__filter-text">Our Team</span>
          </button>
        </div>
      </div>
    {% endif %}

    {% if section.blocks.size > 0 %}
      <div class="portfolio-showcase__wrapper">
        
        {% comment %} Main Content Area - Horizontal Layout {% endcomment %}
        <div class="portfolio-showcase__main-content">
          
          {% comment %} Gallery Section - Left Side {% endcomment %}
          <div class="portfolio-showcase__gallery">
            <div class="portfolio-showcase__main-container">
              <div class="swiper portfolio-showcase__main-swiper">
                <div class="swiper-wrapper">
                  {% assign slide_index = 0 %}
                  {% for block in section.blocks %}
                    {% assign block_filter = block.settings.collection_type | default: 'products' %}
                    {% for i in (1..5) %}
                      {% assign image_key = 'image_' | append: i %}
                      {% assign current_image = block.settings[image_key] %}
                      {% if current_image != blank %}
                        <div class="swiper-slide portfolio-showcase__slide" 
                             data-filter="{{ block_filter }}" 
                             data-product="{{ forloop.index0 }}"
                             data-slide-index="{{ slide_index }}">
                          <div class="portfolio-showcase__slide-inner">
                            {{ current_image | image_url: width: 800 | image_tag: 
                              class: 'portfolio-showcase__image', 
                              loading: 'lazy',
                              alt: block.settings.product_name | escape
                            }}
                            <div class="portfolio-showcase__slide-overlay">
                              <button class="portfolio-showcase__zoom-btn" data-image="{{ current_image | image_url: width: 1600 }}">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                  <path d="M21 21L16.514 16.506M19 10.5C19 15.194 15.194 19 10.5 19S2 15.194 2 10.5 5.806 2 10.5 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                              </button>
                            </div>
                          </div>
                        </div>
                        {% assign slide_index = slide_index | plus: 1 %}
                      {% endif %}
                    {% endfor %}
                  {% endfor %}
                </div>
                
                {% if section.settings.show_navigation %}
                  <div class="portfolio-showcase__navigation">
                    <button class="portfolio-showcase__nav portfolio-showcase__nav--prev swiper-button-prev">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button class="portfolio-showcase__nav portfolio-showcase__nav--next swiper-button-next">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                {% endif %}
                
                {% if section.settings.show_pagination %}
                  <div class="portfolio-showcase__pagination swiper-pagination"></div>
                {% endif %}
              </div>
            </div>
          </div>

          {% comment %} Product Information Panel - Right Side {% endcomment %}
          <div class="portfolio-showcase__info">
            <div class="portfolio-showcase__info-content">
              {% for block in section.blocks %}
                <div class="portfolio-showcase__product-info" 
                     data-product="{{ forloop.index0 }}"
                     data-filter="{{ block.settings.collection_type | default: 'products' }}"
                     {% unless forloop.first %}style="display: none;"{% endunless %}>
                  
                  {% if block.settings.product_name != blank %}
                    <h3 class="portfolio-showcase__product-title">{{ block.settings.product_name }}</h3>
                  {% endif %}

                  {% if block.settings.product_description != blank %}
                    <div class="portfolio-showcase__description">
                      {{ block.settings.product_description }}
                    </div>
                  {% endif %}

                  {% if block.settings.details != blank %}
                    <div class="portfolio-showcase__details">
                      <h4 class="portfolio-showcase__details-title">
                        {% case block.settings.collection_type %}
                          {% when 'factory' %}
                            Facility Details
                          {% when 'team' %}
                            Team Member Info
                          {% else %}
                            Product Details
                        {% endcase %}
                      </h4>
                      <div class="portfolio-showcase__details-content">
                        {{ block.settings.details }}
                      </div>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        {% comment %} Thumbnails - Full Width Below Main Content {% endcomment %}
        {% if section.settings.show_thumbnails %}
          <div class="portfolio-showcase__thumbnails">
            <div class="swiper portfolio-showcase__thumb-swiper">
              <div class="swiper-wrapper">
                {% assign thumb_index = 0 %}
                {% for block in section.blocks %}
                  {% assign block_filter = block.settings.collection_type | default: 'products' %}
                  {% for i in (1..5) %}
                    {% assign image_key = 'image_' | append: i %}
                    {% assign current_image = block.settings[image_key] %}
                    {% if current_image != blank %}
                      <div class="swiper-slide portfolio-showcase__thumb-slide" 
                           data-filter="{{ block_filter }}" 
                           data-product="{{ forloop.index0 }}"
                           data-thumb-index="{{ thumb_index }}">
                        <div class="portfolio-showcase__thumb-container">
                          {{ current_image | image_url: width: 150 | image_tag: 
                            class: 'portfolio-showcase__thumb-image', 
                            loading: 'lazy'
                          }}
                        </div>
                      </div>
                      {% assign thumb_index = thumb_index | plus: 1 %}
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}
      </div>

      {% comment %} Lightbox Modal {% endcomment %}
      <div class="portfolio-showcase__lightbox" id="lightbox-{{ section.id }}">
        <div class="portfolio-showcase__lightbox-backdrop"></div>
        <div class="portfolio-showcase__lightbox-content">
          <button class="portfolio-showcase__lightbox-close">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <img src="" alt="" class="portfolio-showcase__lightbox-image">
        </div>
      </div>

    {% else %}
      <div class="portfolio-showcase__empty">
        <div class="portfolio-showcase__empty-icon">
          <svg width="48" height="48" viewBox="0 0 64 64" fill="none">
            <path d="M32 8L8 20V52H24V36H40V52H56V20L32 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h3>No items to display</h3>
        <p>Add product blocks in the theme editor to showcase your portfolio.</p>
      </div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sectionId = '{{ section.id }}';
  const section = document.querySelector(`[data-section-id="${sectionId}"]`);
  
  if (!section) return;
  
  let mainSwiperInstance = null;
  let thumbSwiperInstance = null;
  let currentFilter = 'products';
  const blocks = {{ section.blocks | json }};
  
  // Helper function to get visible slides for current filter
  function getVisibleSlides(filter) {
    return section.querySelectorAll(`.portfolio-showcase__slide[data-filter="${filter}"]`);
  }
  
  // Helper function to get visible thumbs for current filter
  function getVisibleThumbs(filter) {
    return section.querySelectorAll(`.portfolio-showcase__thumb-slide[data-filter="${filter}"]`);
  }
  
  // Initialize Swipers
  function initializeSwipers() {
    const mainSwiper = section.querySelector('.portfolio-showcase__main-swiper');
    const thumbSwiper = section.querySelector('.portfolio-showcase__thumb-swiper');
    
    if (!mainSwiper) return;

    // Destroy existing instances
    if (mainSwiperInstance) {
      mainSwiperInstance.destroy(true, true);
      mainSwiperInstance = null;
    }
    if (thumbSwiperInstance) {
      thumbSwiperInstance.destroy(true, true);
      thumbSwiperInstance = null;
    }

    // Get only visible slides and thumbnails for current filter
    const visibleSlides = Array.from(section.querySelectorAll(`.portfolio-showcase__slide[data-filter="${currentFilter}"]`));
    const visibleThumbs = Array.from(section.querySelectorAll(`.portfolio-showcase__thumb-slide[data-filter="${currentFilter}"]`));

    // Initialize thumbnail swiper first (only if we have visible thumbnails)
    if (thumbSwiper && visibleThumbs.length > 0) {
      thumbSwiperInstance = new Swiper(thumbSwiper, {
        spaceBetween: 10,
        slidesPerView: 'auto',
        freeMode: true,
        watchSlidesProgress: true,
        breakpoints: {
          640: { slidesPerView: 'auto', spaceBetween: 12 },
          768: { slidesPerView: 'auto', spaceBetween: 16 }
        }
      });
    }

    // Initialize main swiper (only if we have visible slides)
    if (visibleSlides.length > 0) {
      mainSwiperInstance = new Swiper(mainSwiper, {
        spaceBetween: 0,
        effect: 'fade',
        fadeEffect: { crossFade: true },
        speed: 600,
        autoplay: {{ section.settings.autoplay | json }} ? {
          delay: {{ section.settings.autoplay_speed | times: 1000 }},
          disableOnInteraction: false,
          pauseOnMouseEnter: true
        } : false,
        navigation: {
          nextEl: section.querySelector('.portfolio-showcase__nav--next'),
          prevEl: section.querySelector('.portfolio-showcase__nav--prev'),
        },
        pagination: {
          el: section.querySelector('.portfolio-showcase__pagination'),
          clickable: true,
        },
        thumbs: thumbSwiperInstance ? { swiper: thumbSwiperInstance } : undefined,
        on: {
          slideChange: function() {
            updateProductInfo(this.activeIndex);
          }
        }
      });
    }
  }

  // Update product information based on active slide
  function updateProductInfo(slideIndex) {
    const visibleSlides = getVisibleSlides(currentFilter);
    if (slideIndex >= visibleSlides.length) return;
    
    const activeSlide = visibleSlides[slideIndex];
    if (!activeSlide) return;
    
    const productIndex = parseInt(activeSlide.getAttribute('data-product'));
    
    // Hide all product info
    section.querySelectorAll('.portfolio-showcase__product-info').forEach(info => {
      info.style.display = 'none';
    });
    
    // Show the correct product info
    const targetInfo = section.querySelector(`.portfolio-showcase__product-info[data-product="${productIndex}"][data-filter="${currentFilter}"]`);
    if (targetInfo) {
      targetInfo.style.display = 'block';
    }
  }

  // Filter functionality
  function filterContent(filter) {
    currentFilter = filter;
    
    // Update filter tabs
    section.querySelectorAll('.portfolio-showcase__filter-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    section.querySelector(`[data-filter="${filter}"]`).classList.add('active');
    
    // Hide ALL slides first
    section.querySelectorAll('.portfolio-showcase__slide').forEach(slide => {
      slide.style.display = 'none';
    });
    
    // Hide ALL thumbnails first  
    section.querySelectorAll('.portfolio-showcase__thumb-slide').forEach(slide => {
      slide.style.display = 'none';
    });
    
    // Hide ALL product info first
    section.querySelectorAll('.portfolio-showcase__product-info').forEach(info => {
      info.style.display = 'none';
    });
    
    // Now show only the items that match the current filter
    section.querySelectorAll(`.portfolio-showcase__slide[data-filter="${filter}"]`).forEach(slide => {
      slide.style.display = 'block';
    });
    
    section.querySelectorAll(`.portfolio-showcase__thumb-slide[data-filter="${filter}"]`).forEach(slide => {
      slide.style.display = 'block';
    });
    
    // Show first product info for this filter
    const firstProductInfo = section.querySelector(`.portfolio-showcase__product-info[data-filter="${filter}"]`);
    if (firstProductInfo) {
      firstProductInfo.style.display = 'block';
    }
    
    // Force Swiper to update its slides count after DOM changes
    setTimeout(() => {
      // Trigger Swiper update to recognize filtered slides
      if (mainSwiperInstance) {
        mainSwiperInstance.update();
        mainSwiperInstance.updateSlides();
        mainSwiperInstance.updateProgress();
        mainSwiperInstance.updateSlidesClasses();
      }
      
      if (thumbSwiperInstance) {
        thumbSwiperInstance.update();
        thumbSwiperInstance.updateSlides();
        thumbSwiperInstance.updateProgress();
        thumbSwiperInstance.updateSlidesClasses();
      }
      
      // Reinitialize swipers for clean state
      initializeSwipers();
      
      // Reset to first slide when switching filters
      if (mainSwiperInstance) {
        mainSwiperInstance.slideTo(0, 0);
      }
    }, 150);
  }

  // Event listeners for filter tabs
  section.querySelectorAll('.portfolio-showcase__filter-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const filter = this.getAttribute('data-filter');
      filterContent(filter);
    });
  });

  // Lightbox functionality
  const lightbox = section.querySelector('.portfolio-showcase__lightbox');
  const lightboxImage = lightbox.querySelector('.portfolio-showcase__lightbox-image');
  
  section.addEventListener('click', function(e) {
    if (e.target.closest('.portfolio-showcase__zoom-btn')) {
      e.preventDefault();
      e.stopPropagation();
      const btn = e.target.closest('.portfolio-showcase__zoom-btn');
      const imageUrl = btn.getAttribute('data-image');
      lightboxImage.src = imageUrl;
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
  });

  lightbox.querySelector('.portfolio-showcase__lightbox-close').addEventListener('click', function() {
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
  });

  lightbox.addEventListener('click', function(e) {
    if (e.target === lightbox || e.target.classList.contains('portfolio-showcase__lightbox-backdrop')) {
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
    }
  });

  // Initialize everything
  initializeSwipers();
  
  // Set initial filter to products
  filterContent('products');
});
</script>

{% schema %}
{
  "name": "Portfolio Showcase",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Section Header"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Our Manufacturing Portfolio"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "Description",
      "default": "<p>Explore our previous work and see the quality craftsmanship that goes into every piece we manufacture.</p>"
    },
    {
      "type": "header",
      "content": "Collection Filter"
    },
    {
      "type": "checkbox",
      "id": "show_collection_filter",
      "label": "Show collection type filter",
      "default": true,
      "info": "Allows filtering between Products, Factory, and Team"
    },
    {
      "type": "header",
      "content": "Display Options"
    },
    {
      "type": "checkbox",
      "id": "show_thumbnails",
      "label": "Show thumbnail navigation",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "Show arrow navigation",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_pagination",
      "label": "Show dot pagination",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Auto-rotate slides",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 3,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Auto-rotate speed",
      "default": 5
    }
  ],
  "blocks": [
    {
      "type": "item",
      "name": "Portfolio Item",
      "limit": 20,
      "settings": [
        {
          "type": "select",
          "id": "collection_type",
          "label": "Collection Type",
          "options": [
            {
              "value": "products",
              "label": "Our Products"
            },
            {
              "value": "factory",
              "label": "Our Factory"
            },
            {
              "value": "team",
              "label": "Our Team"
            }
          ],
          "default": "products"
        },
        {
          "type": "text",
          "id": "product_name",
          "label": "Item Name",
          "default": "Premium Hoodie"
        },
        {
          "type": "richtext",
          "id": "product_description",
          "label": "Description",
          "default": "<p>High-quality item crafted with attention to detail and premium materials.</p>"
        },
        {
          "type": "richtext",
          "id": "details",
          "label": "Details",
          "default": "<p><strong>Material:</strong> 100% Cotton<br><strong>Weight:</strong> 280 GSM<br><strong>Sizes:</strong> XS - 3XL</p>"
        },
        {
          "type": "header",
          "content": "Images (up to 5)"
        },
        {
          "type": "image_picker",
          "id": "image_1",
          "label": "Image 1"
        },
        {
          "type": "image_picker",
          "id": "image_2",
          "label": "Image 2"
        },
        {
          "type": "image_picker",
          "id": "image_3",
          "label": "Image 3"
        },
        {
          "type": "image_picker",
          "id": "image_4",
          "label": "Image 4"
        },
        {
          "type": "image_picker",
          "id": "image_5",
          "label": "Image 5"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Portfolio Showcase",
      "blocks": [
        {
          "type": "item",
          "settings": {
            "collection_type": "products",
            "product_name": "Premium Cotton Hoodie",
            "product_description": "<p>Expertly crafted hoodie featuring premium cotton blend, reinforced stitching, and superior comfort.</p>",
            "details": "<p><strong>Material:</strong> 80% Cotton, 20% Polyester<br><strong>Weight:</strong> 320 GSM<br><strong>Features:</strong> Kangaroo pocket, ribbed cuffs<br><strong>Colors:</strong> Available in 25+ colors</p>"
          }
        },
        {
          "type": "item",
          "settings": {
            "collection_type": "factory",
            "product_name": "Production Floor",
            "product_description": "<p>State-of-the-art manufacturing facility with modern equipment and quality control processes.</p>",
            "details": "<p><strong>Capacity:</strong> 10,000+ pieces/month<br><strong>Equipment:</strong> Industrial sewing machines<br><strong>Quality:</strong> ISO certified processes</p>"
          }
        },
        {
          "type": "item",
          "settings": {
            "collection_type": "team",
            "product_name": "Production Manager",
            "product_description": "<p>Meet our experienced production team dedicated to delivering exceptional quality in every piece.</p>",
            "details": "<p><strong>Experience:</strong> 15+ years<br><strong>Specialty:</strong> Quality control<br><strong>Role:</strong> Production oversight</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}