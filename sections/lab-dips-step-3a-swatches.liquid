{% comment %}
Lab Dips & Brand Accessories - Step 3A: Lab Dip Swatches
{% endcomment %}

<link rel="stylesheet" href="{{ 'techpack-unified-styles.css' | asset_url }}?v={{ 'now' | date: '%s' }}">

<section id="lab-dips-step-3a" class="techpack-step" data-step="3a" style="display: none;">
  <div class="techpack-container">
    
    <!-- Progress Bar for Lab Dips Workflow -->
    <div class="techpack-progress">
      <div class="techpack-progress__bar">
        <div class="techpack-progress__fill" style="width: 100%"></div>
      </div>
      <div class="techpack-progress__steps">
        <div class="techpack-progress__step techpack-progress__step--completed">
          <div class="techpack-progress__step-circle techpack-progress__step--completed">1</div>
          <div class="techpack-progress__step-label">Service Selection</div>
        </div>
        <div class="techpack-progress__step techpack-progress__step--active">
          <div class="techpack-progress__step-circle techpack-progress__step-circle--active">2</div>
          <div class="techpack-progress__step-label">Lab Dip Swatches</div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="techpack-content">
      
      <!-- Header -->
      <div class="techpack-step-header">
        <h2 class="techpack-step-title">Lab Dip Swatches</h2>
        <p class="techpack-step-subtitle">Order fabric swatches for perfect color matching and material approval</p>
      </div>

      <!-- Service Info -->
      <div class="techpack-service-info-banner">
        <div class="techpack-service-info-content">
          <div class="techpack-service-info-item">
            <div class="techpack-service-info-icon">ðŸ’°</div>
            <div class="techpack-service-info-text">
              <strong>25â‚¬ per swatch</strong>
              <span>High-quality fabric samples</span>
            </div>
          </div>
          <div class="techpack-service-info-item">
            <div class="techpack-service-info-icon">âš¡</div>
            <div class="techpack-service-info-text">
              <strong>1-2 weeks delivery</strong>
              <span>Fast turnaround time</span>
            </div>
          </div>
          <div class="techpack-service-info-item">
            <div class="techpack-service-info-icon">ðŸŽ¨</div>
            <div class="techpack-service-info-text">
              <strong>Perfect color matching</strong>
              <span>Pantone color system</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Color Selection System -->
      <div class="techpack-lab-dip-selection-system">
        <div class="techpack-section-header">
          <h3 class="techpack-section-title">Create Lab Dip Swatches</h3>
          <p class="techpack-section-description">Choose colors using our professional color picker or enter specific Pantone codes</p>
        </div>

        <!-- Color Input Mode Toggle -->
        <div class="techpack-input-mode-toggle">
          <button type="button" class="techpack-mode-btn techpack-mode-btn--active" data-mode="color-picker" id="swatch-color-picker-mode">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <path d="M12.83 2.17a4 4 0 0 0-5.66 0L4.2 5.14a1 1 0 0 0-.29.71v4.29a1 1 0 0 0 1 1h4.29a1 1 0 0 0 .71-.29l2.97-2.97a4 4 0 0 0 0-5.66z"/>
              <path d="M8.5 12.5L15 6l-3-3-6.5 6.5"/>
            </svg>
            Color Picker
          </button>
          <button type="button" class="techpack-mode-btn" data-mode="manual-entry" id="swatch-manual-entry-mode">
            <svg width="16" height="16" viewBox="0 0 16 16">
              <path d="M1 4h14M1 8h14M1 12h8"/>
            </svg>
            Manual Code
          </button>
        </div>

        <!-- Color Picker Mode -->
        <div class="techpack-input-mode techpack-input-mode--active" id="swatch-color-picker-input">
          <div class="techpack-swatch-color-picker-group">
            <!-- Color Input and Preview -->
            <div class="techpack-color-picker-section">
              <div class="techpack-color-preview-wrapper">
                <input type="color" id="swatch-color-picker" class="techpack-color-picker__input" value="#FF0000">
                <div class="techpack-color-picker__preview" id="swatch-color-preview"></div>
              </div>
              <div class="techpack-color-picker-label">Pick your color</div>
            </div>
            
            <!-- Auto-Selected Pantone Display -->
            <div class="techpack-auto-pantone-section">
              <div class="techpack-auto-pantone-display" id="swatch-auto-pantone-display" style="display: none;">
                <div class="techpack-pantone-result">
                  <div class="techpack-pantone-circle" id="swatch-auto-pantone-circle"></div>
                  <div class="techpack-pantone-info">
                    <div class="techpack-pantone-code" id="swatch-auto-pantone-code">Select a color</div>
                    <div class="techpack-pantone-note">Auto-matched from 2,310+ colors</div>
                  </div>
                </div>
              </div>
              <div class="techpack-pantone-placeholder" id="swatch-pantone-placeholder">
                <div class="techpack-pantone-placeholder-icon">ðŸŽ¨</div>
                <div class="techpack-pantone-placeholder-text">Pick a color to see Pantone match</div>
              </div>
            </div>
            
            <!-- Add Button -->
            <div class="techpack-add-button-section">
              <button type="button" id="add-swatch-color" class="techpack-btn techpack-btn--primary" disabled>
                <svg width="14" height="14" viewBox="0 0 16 16">
                  <path d="M8 2v12m-6-6h12" stroke="currentColor" stroke-width="2"/>
                </svg>
                Add Swatch (25â‚¬)
              </button>
            </div>
          </div>
        </div>

        <!-- Manual Entry Mode -->
        <div class="techpack-input-mode" id="swatch-manual-entry-input">
          <div class="techpack-manual-entry-group">
            <input type="text" id="swatch-manual-pantone-code" class="techpack-form__input techpack-form__input--compact" placeholder="Enter Pantone code (e.g., 18-1664 TPX)">
            <button type="button" id="add-swatch-manual" class="techpack-btn techpack-btn--primary">
              <svg width="14" height="14" viewBox="0 0 16 16">
                <path d="M8 2v12m-6-6h12" stroke="currentColor" stroke-width="2"/>
              </svg>
              Add Swatch (25â‚¬)
            </button>
          </div>
        </div>

      </div>

      <!-- Swatch Cart Summary -->
      <div class="techpack-swatch-cart" id="swatch-cart" style="display: none;">
        <div class="techpack-section-header">
          <h3 class="techpack-section-title">Your Lab Dip Swatches</h3>
          <p class="techpack-section-description">Review your selected swatches before submitting your order</p>
        </div>

        <div class="techpack-swatch-list" id="swatch-list">
          <!-- Swatches will be populated here -->
        </div>

        <!-- Order Summary -->
        <div class="techpack-order-summary">
          <div class="techpack-order-summary-content">
            <div class="techpack-order-summary-row">
              <span class="techpack-order-summary-label">Swatches:</span>
              <span class="techpack-order-summary-value" id="swatch-count">0</span>
            </div>
            <div class="techpack-order-summary-row">
              <span class="techpack-order-summary-label">Price per swatch:</span>
              <span class="techpack-order-summary-value">25â‚¬</span>
            </div>
            <div class="techpack-order-summary-row techpack-order-summary-row--total">
              <span class="techpack-order-summary-label">Total:</span>
              <span class="techpack-order-summary-value" id="swatch-total">0â‚¬</span>
            </div>
            <div class="techpack-order-summary-row">
              <span class="techpack-order-summary-label">Delivery:</span>
              <span class="techpack-order-summary-value">1-2 weeks</span>
            </div>
          </div>
        </div>

      </div>

      <!-- Navigation -->
      <div class="techpack-step-navigation">
        <button type="button" class="techpack-btn techpack-btn--secondary" id="swatch-back-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="m15 18-6-6 6-6" stroke="currentColor" stroke-width="2"/>
          </svg>
          Back
        </button>
        
        <button type="button" class="techpack-btn techpack-btn--primary techpack-btn--large" id="submit-swatch-order-btn" disabled>
          Submit Lab Dip Order
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M5 12h14m-7-7 7 7-7 7" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
      </div>

    </div>
  </div>
</section>

<style>
/* Lab Dip Swatches Specific Styles */
.techpack-service-info-banner {
  background: linear-gradient(135deg, rgba(0, 123, 255, 0.1), rgba(0, 123, 255, 0.05));
  border: 1px solid rgba(0, 123, 255, 0.2);
  border-radius: 12px;
  padding: 1.5rem;
  margin: 2rem 0;
}

.techpack-service-info-content {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.techpack-service-info-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.techpack-service-info-icon {
  font-size: 1.5rem;
  width: 40px;
  height: 40px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.techpack-service-info-text {
  display: flex;
  flex-direction: column;
  gap: 0.125rem;
}

.techpack-service-info-text strong {
  font-weight: 600;
  color: var(--techpack-text-primary, #2c3e50);
  font-size: 0.9rem;
}

.techpack-service-info-text span {
  color: var(--techpack-text-secondary, #6c757d);
  font-size: 0.8rem;
}

/* Color Selection System */
.techpack-lab-dip-selection-system {
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 1.5rem;
  margin: 2rem 0;
}

.techpack-swatch-color-picker-group {
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 1.5rem;
  align-items: center;
  max-width: 800px;
}

.techpack-color-picker-label {
  font-size: 0.85rem;
  color: var(--techpack-text-secondary, #6c757d);
  text-align: center;
  margin-top: 0.5rem;
}

/* Swatch Cart */
.techpack-swatch-cart {
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 1.5rem;
  margin: 2rem 0;
}

.techpack-swatch-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.techpack-swatch-item {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  padding: 1rem;
  text-align: center;
  position: relative;
}

.techpack-swatch-color-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin: 0 auto 0.5rem;
  border: 2px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.techpack-swatch-code {
  font-size: 0.8rem;
  font-weight: 500;
  color: var(--techpack-text-primary, #2c3e50);
  margin-bottom: 0.25rem;
}

.techpack-swatch-price {
  font-size: 0.75rem;
  color: var(--techpack-text-secondary, #6c757d);
}

.techpack-swatch-remove {
  position: absolute;
  top: 0.25rem;
  right: 0.25rem;
  width: 20px;
  height: 20px;
  border: none;
  background: rgba(220, 53, 69, 0.1);
  color: #dc3545;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  transition: all 0.2s ease;
}

.techpack-swatch-remove:hover {
  background: rgba(220, 53, 69, 0.2);
}

/* Order Summary */
.techpack-order-summary {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  padding: 1rem;
}

.techpack-order-summary-content {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.techpack-order-summary-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.9rem;
}

.techpack-order-summary-row--total {
  padding-top: 0.5rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  font-weight: 600;
  font-size: 1rem;
}

.techpack-order-summary-label {
  color: var(--techpack-text-secondary, #6c757d);
}

.techpack-order-summary-value {
  color: var(--techpack-text-primary, #2c3e50);
  font-weight: 500;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
  .techpack-service-info-content {
    grid-template-columns: 1fr;
  }
  
  .techpack-swatch-color-picker-group {
    grid-template-columns: 1fr;
    gap: 1rem;
    text-align: center;
  }
  
  .techpack-swatch-list {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  }
}

/* Animation */
@keyframes swatchAdded {
  0% { opacity: 0; transform: scale(0.8) translateY(10px); }
  100% { opacity: 1; transform: scale(1) translateY(0); }
}

.techpack-swatch-item {
  animation: swatchAdded 0.3s ease;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Elements
  const colorPickerModeBtn = document.getElementById('swatch-color-picker-mode');
  const manualEntryModeBtn = document.getElementById('swatch-manual-entry-mode');
  const colorPickerInput = document.getElementById('swatch-color-picker-input');
  const manualEntryInput = document.getElementById('swatch-manual-entry-input');
  
  const colorPicker = document.getElementById('swatch-color-picker');
  const colorPreview = document.getElementById('swatch-color-preview');
  const addColorBtn = document.getElementById('add-swatch-color');
  const addManualBtn = document.getElementById('add-swatch-manual');
  const manualInput = document.getElementById('swatch-manual-pantone-code');
  
  const autoPantoneDisplay = document.getElementById('swatch-auto-pantone-display');
  const pantoneCircle = document.getElementById('swatch-auto-pantone-circle');
  const pantoneCode = document.getElementById('swatch-auto-pantone-code');
  const pantonePlaceholder = document.getElementById('swatch-pantone-placeholder');
  
  const swatchCart = document.getElementById('swatch-cart');
  const swatchList = document.getElementById('swatch-list');
  const swatchCount = document.getElementById('swatch-count');
  const swatchTotal = document.getElementById('swatch-total');
  const submitOrderBtn = document.getElementById('submit-swatch-order-btn');
  const backBtn = document.getElementById('swatch-back-btn');
  
  let swatches = [];
  let currentSwatchPrice = 25; // 25â‚¬ per swatch

  // Mode toggle functionality
  colorPickerModeBtn.addEventListener('click', () => switchMode('color-picker'));
  manualEntryModeBtn.addEventListener('click', () => switchMode('manual-entry'));

  function switchMode(mode) {
    // Toggle button states
    colorPickerModeBtn.classList.toggle('techpack-mode-btn--active', mode === 'color-picker');
    manualEntryModeBtn.classList.toggle('techpack-mode-btn--active', mode === 'manual-entry');
    
    // Toggle input sections
    colorPickerInput.classList.toggle('techpack-input-mode--active', mode === 'color-picker');
    manualEntryInput.classList.toggle('techpack-input-mode--active', mode === 'manual-entry');
  }

  // Color picker functionality
  colorPicker.addEventListener('input', function() {
    const color = this.value;
    colorPreview.style.backgroundColor = color;
    
    // Simulate Pantone matching (you would replace with actual API)
    findPantoneMatch(color);
    
    addColorBtn.disabled = false;
  });

  function findPantoneMatch(color) {
    // Simulate finding closest Pantone color
    // In real implementation, this would call the GlobalLabDipManager
    setTimeout(() => {
      const mockPantoneCode = generateMockPantoneCode(color);
      showPantoneMatch(mockPantoneCode, color);
    }, 200);
  }

  function generateMockPantoneCode(color) {
    // Simple mock - in real app use actual Pantone database
    const r = parseInt(color.substring(1, 3), 16);
    const g = parseInt(color.substring(3, 5), 16);
    const b = parseInt(color.substring(5, 7), 16);
    const code = `${Math.floor(r/10)}-${Math.floor(g/10)}${Math.floor(b/10)} TPX`;
    return code;
  }

  function showPantoneMatch(code, color) {
    pantonePlaceholder.style.display = 'none';
    autoPantoneDisplay.style.display = 'block';
    pantoneCircle.style.backgroundColor = color;
    pantoneCode.textContent = code;
  }

  // Add swatch functionality
  addColorBtn.addEventListener('click', function() {
    const color = colorPicker.value;
    const code = pantoneCode.textContent;
    addSwatch(code, color);
  });

  addManualBtn.addEventListener('click', function() {
    const code = manualInput.value.trim();
    if (code) {
      addSwatch(code, '#888888'); // Default color for manual entry
      manualInput.value = '';
    }
  });

  manualInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      addManualBtn.click();
    }
  });

  function addSwatch(code, color) {
    // Check for duplicates
    if (swatches.some(swatch => swatch.code === code)) {
      alert('This swatch is already in your order.');
      return;
    }

    const swatch = {
      id: Date.now(),
      code: code,
      color: color,
      price: currentSwatchPrice
    };

    swatches.push(swatch);
    renderSwatches();
    updateOrderSummary();
    
    // Show cart if first swatch
    if (swatches.length === 1) {
      swatchCart.style.display = 'block';
    }
  }

  function renderSwatches() {
    swatchList.innerHTML = swatches.map(swatch => `
      <div class="techpack-swatch-item">
        <button type="button" class="techpack-swatch-remove" onclick="removeSwatch(${swatch.id})">Ã—</button>
        <div class="techpack-swatch-color-circle" style="background-color: ${swatch.color}"></div>
        <div class="techpack-swatch-code">${swatch.code}</div>
        <div class="techpack-swatch-price">${swatch.price}â‚¬</div>
      </div>
    `).join('');
  }

  window.removeSwatch = function(id) {
    swatches = swatches.filter(swatch => swatch.id !== id);
    renderSwatches();
    updateOrderSummary();
    
    if (swatches.length === 0) {
      swatchCart.style.display = 'none';
    }
  };

  function updateOrderSummary() {
    const count = swatches.length;
    const total = count * currentSwatchPrice;
    
    swatchCount.textContent = count;
    swatchTotal.textContent = `${total}â‚¬`;
    
    submitOrderBtn.disabled = count === 0;
  }

  // Navigation
  backBtn.addEventListener('click', function() {
    window.dispatchEvent(new CustomEvent('techpack:navigateToStep', {
      detail: { step: 'lab-dips-step-1' }
    }));
  });

  submitOrderBtn.addEventListener('click', function() {
    if (swatches.length === 0) return;
    
    // Store order data
    if (window.techPackState) {
      window.techPackState.formData.labDipSwatches = swatches;
      window.techPackState.formData.labDipOrderTotal = swatches.length * currentSwatchPrice;
    }
    
    // Show success message and complete workflow
    alert(`Lab Dip Order Submitted!\n\n${swatches.length} swatches ordered\nTotal: ${swatches.length * currentSwatchPrice}â‚¬\nDelivery: 1-2 weeks\n\nYou will receive a confirmation email shortly.`);
    
    // Navigate back to submission type or reset workflow
    window.dispatchEvent(new CustomEvent('techpack:navigateToStep', {
      detail: { step: 'submission-type-selection' }
    }));
  });

  // Initialize color preview
  colorPreview.style.backgroundColor = colorPicker.value;
});
</script>