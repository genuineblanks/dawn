{% comment %}
  TechPack V11 - Bulk Order - Step 4: Color & Quantity Assignment
  Purpose: Assign colorways (colors + quantities + size distributions) to garments
  Flow: Select color → Enter quantity (with MOQ) → Distribute sizes → Copy to others (optional)
  Features: Lab Dip Cart, MOQ validation, size distribution, Quick Fill templates
{% endcomment %}

{{ 'techpack-v11-base.css' | asset_url | stylesheet_tag }}
{{ 'techpack-v11-flow.css' | asset_url | stylesheet_tag }}
{{ 'techpack-v11-forms.css' | asset_url | stylesheet_tag }}
{{ 'techpack-v11-bulk.css' | asset_url | stylesheet_tag }}
{{ 'techpack-v11-modals.css' | asset_url | stylesheet_tag }}
{{ 'techpack-v11-step3b.css' | asset_url | stylesheet_tag }}
{%- comment -%} Modal and colorway styles {%- endcomment -%}

<div class="techpack-v11 techpack-flow" id="bulkStep4" data-section-id="{{ section.id }}" data-flow-type="bulk" data-current-step="4">

  {%- comment -%} Progress Header {%- endcomment -%}
  <div class="techpack-progress">
    <div class="techpack-progress__container">
      <button type="button" class="techpack-progress__back" data-action="previous-step">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Back</span>
      </button>

      <div class="techpack-progress__steps">
        <div class="progress-step progress-step--complete" data-step="1">
          <div class="progress-step__circle">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M13.333 4L6 11.333L2.667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="progress-step__label">Client Info</div>
        </div>
        <div class="progress-step__line"></div>
        <div class="progress-step progress-step--complete" data-step="2">
          <div class="progress-step__circle">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M13.333 4L6 11.333L2.667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="progress-step__label">Files</div>
        </div>
        <div class="progress-step__line"></div>
        <div class="progress-step progress-step--complete" data-step="3">
          <div class="progress-step__circle">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M13.333 4L6 11.333L2.667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="progress-step__label">Garments</div>
        </div>
        <div class="progress-step__line"></div>
        <div class="progress-step progress-step--active" data-step="4">
          <div class="progress-step__circle">4</div>
          <div class="progress-step__label">Colors</div>
        </div>
        <div class="progress-step__line"></div>
        <div class="progress-step" data-step="5">
          <div class="progress-step__circle">5</div>
          <div class="progress-step__label">Review</div>
        </div>
      </div>

      <div class="techpack-progress__save">
        <div class="save-indicator" id="saveIndicator">
          <svg class="save-indicator__icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.333 4L6 11.333L2.667 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="save-indicator__text">All saved</span>
        </div>
      </div>
    </div>
  </div>

  {%- comment -%} Main Content {%- endcomment -%}
  <div class="techpack-content">
    <div class="techpack-content__container techpack-content__container--wide">

      {%- comment -%} Step Header {%- endcomment -%}
      <header class="step-header">
        <div class="step-header__badge">Step 4 of 5</div>
        <h1 class="step-header__title">Configure Colorways & Quantities</h1>
        <p class="step-header__description">
          Add colors with quantities and size distributions for each garment
        </p>
      </header>

      {%- comment -%} MOQ Progress Bar {%- endcomment -%}
      <div class="moq-progress-bar" id="moqProgressBar">
        <div class="moq-progress-bar__header">
          <div class="moq-progress-bar__title">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 2v16M2 10h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>Order Progress</span>
          </div>
          <div class="moq-progress-bar__stats">
            <span class="moq-progress-bar__current" id="moqCurrent">0</span>
            <span class="moq-progress-bar__separator">/</span>
            <span class="moq-progress-bar__target">75 pcs minimum</span>
          </div>
        </div>
        <div class="moq-progress-bar__track">
          <div class="moq-progress-bar__fill" id="moqProgressFill" style="width: 0%;"></div>
        </div>
        <div class="moq-progress-bar__message" id="moqMessage">
          Add colorways to reach the 75-piece minimum order quantity
        </div>
      </div>

      {%- comment -%} 2-COLUMN LAYOUT: 70% Garments / 30% Summary {%- endcomment -%}
      <div class="step3b-layout">

        {%- comment -%} LEFT COLUMN: Garment List (70%) {%- endcomment -%}
        <div class="step3b-left">

          {%- comment -%} Collapsible Speed Guide {%- endcomment -%}
          <div class="speed-guide" id="speedGuide">
            <button type="button" class="speed-guide__toggle" data-action="toggle-speed-guide">
              <svg class="speed-guide__icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>Color Options Guide</span>
            </button>

            <div class="speed-guide__content" id="speedGuideContent" style="display: none;">
              <div class="speed-guide__item">
                <div class="speed-guide__item-header">
                  <span class="speed-guide__color-badge speed-guide__color-badge--blue"></span>
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 10L8 13L15 6" stroke="#3B82F6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <h4 class="speed-guide__item-title">Stock Colors - 6-8 weeks (All Fabrics)</h4>
                </div>
                <p class="speed-guide__item-text">Pre-made swatches in standard colors. Fastest production time.</p>
              </div>

              <div class="speed-guide__item">
                <div class="speed-guide__item-header">
                  <span class="speed-guide__color-badge speed-guide__color-badge--purple"></span>
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="7" cy="7" r="4" stroke="#A855F7" stroke-width="2"/>
                    <circle cx="13" cy="13" r="4" stroke="#A855F7" stroke-width="2"/>
                  </svg>
                  <h4 class="speed-guide__item-title">Pantone Custom - 8-10 weeks (100% Cotton Only)</h4>
                </div>
                <p class="speed-guide__item-text">Exact custom Pantone color development. Order lab dip swatches (€25 each) for approval before bulk production.</p>
              </div>

              <div class="speed-guide__item">
                <div class="speed-guide__item-header">
                  <span class="speed-guide__color-badge speed-guide__color-badge--gray"></span>
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 3H14L16 5V17H6V3Z" stroke="#6B7280" stroke-width="2"/>
                    <path d="M9 8H13M9 11H13M9 14H11" stroke="#6B7280" stroke-width="2"/>
                  </svg>
                  <h4 class="speed-guide__item-title">Match TechPack Colors - 6-10 weeks (All Fabrics)</h4>
                </div>
                <p class="speed-guide__item-text">For brands with complete techpack documentation</p>
                <ul class="speed-guide__item-list">
                  <li>Cotton: Exact Pantone code matching</li>
                  <li>Non-Cotton: Closest possible color match</li>
                  <li>Also for: Patterns, prints, multi-color designs</li>
                </ul>
              </div>
            </div>
          </div>

          {%- comment -%} Garment List with Colorways {%- endcomment -%}
          <div class="garment-colorway-list" id="garmentColorwayList">
            {%- comment -%} Populated by JavaScript {%- endcomment -%}
          </div>

        </div>

        {%- comment -%} RIGHT COLUMN: Lab Dip Cart (30%) {%- endcomment -%}
        <div class="step3b-right">
          {%- comment -%} Lab Dip Cart {%- endcomment -%}
          {% render 'techpack-v11-lab-dip-cart' %}
        </div>

      </div>

      {%- comment -%} FULL-WIDTH ORDER SUMMARY (Below 2-column layout) {%- endcomment -%}
      <div class="order-summary-card" id="orderSummaryCard">
        <div class="order-summary-card__header">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke="currentColor" stroke-width="2"/>
          </svg>
          <h3 class="order-summary-card__title">Order Summary</h3>
        </div>
        <div class="order-summary-card__content" id="orderSummaryContent">
          <div class="order-summary-empty">
            <p>Add colorways to see your order summary</p>
          </div>
        </div>
      </div>

      {%- comment -%} Form Navigation {%- endcomment -%}
      <div class="form-navigation" id="bulkStep4Navigation">
        <button
          type="button"
          class="button-secondary"
          data-action="previous-step"
        >
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Back to Garments
        </button>

        <button
          type="button"
          class="button-primary"
          data-action="next-step"
          id="bulkContinueToReview"
        >
          Continue to Review
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

    </div>
  </div>

</div>

{%- comment -%} MODALS {%- endcomment -%}

{%- comment -%} Stock Colors Modal {%- endcomment -%}
<div class="modal-overlay" id="stockColorsModal" style="display: none;">
  <div class="modal-container modal-container--md">
    <div class="modal-header">
      <h3 class="modal-title">Select Stock Color</h3>
      <button type="button" class="modal-close" data-action="close-stock-colors-modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="stock-colors-grid">
        <button type="button" class="stock-color-swatch" data-color="Black" data-hex="#000000" data-action="select-stock-color">
          <div class="stock-color-swatch__color" style="background-color: #000000;"></div>
          <span class="stock-color-swatch__name">Black</span>
        </button>
        <button type="button" class="stock-color-swatch" data-color="White" data-hex="#FFFFFF" data-action="select-stock-color">
          <div class="stock-color-swatch__color" style="background-color: #FFFFFF; border: 1px solid #e5e7eb;"></div>
          <span class="stock-color-swatch__name">White</span>
        </button>
        <button type="button" class="stock-color-swatch" data-color="Navy" data-hex="#000080" data-action="select-stock-color">
          <div class="stock-color-swatch__color" style="background-color: #000080;"></div>
          <span class="stock-color-swatch__name">Navy</span>
        </button>
        <button type="button" class="stock-color-swatch" data-color="Grey" data-hex="#808080" data-action="select-stock-color">
          <div class="stock-color-swatch__color" style="background-color: #808080;"></div>
          <span class="stock-color-swatch__name">Grey</span>
        </button>
        <button type="button" class="stock-color-swatch" data-color="Red" data-hex="#FF0000" data-action="select-stock-color">
          <div class="stock-color-swatch__color" style="background-color: #FF0000;"></div>
          <span class="stock-color-swatch__name">Red</span>
        </button>
        <button type="button" class="stock-color-swatch" data-color="Royal Blue" data-hex="#4169E1" data-action="select-stock-color">
          <div class="stock-color-swatch__color" style="background-color: #4169E1;"></div>
          <span class="stock-color-swatch__name">Royal Blue</span>
        </button>
      </div>
    </div>
  </div>
</div>

{%- comment -%} Quantity Modal {%- endcomment -%}
<div class="modal-overlay" id="quantityModal" style="display: none;">
  <div class="modal-container modal-container--sm">
    <div class="modal-header">
      <h3 class="modal-title" id="quantityModalTitle">How Many Pieces?</h3>
      <button type="button" class="modal-close" data-action="close-quantity-modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="quantity-preview" id="quantityPreview">
        {%- comment -%} Shows garment + color {%- endcomment -%}
      </div>

      <div class="form-field">
        <label for="colorwayQuantity" class="form-field__label">
          Quantity (pieces)
          <span class="form-field__required">*</span>
        </label>
        <input
          type="number"
          id="colorwayQuantity"
          class="form-field__input"
          placeholder="100"
          min="1"
          step="1"
        >
        <p class="form-field__help" id="quantityModalHelp">
          Minimum: 100 pieces for this garment type
        </p>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="button-secondary" data-action="close-quantity-modal">Cancel</button>
      <button type="button" class="button-primary" data-action="continue-to-sizes">
        Continue to Sizes
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</div>

{%- comment -%} Size Distribution Modal {%- endcomment -%}
<div class="modal-overlay" id="sizeDistributionModal" style="display: none;">
  <div class="modal-container modal-container--lg">
    <div class="modal-header">
      <h3 class="modal-title" id="sizeModalTitle">Distribute Sizes</h3>
      <button type="button" class="modal-close" data-action="close-size-modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">

      <div class="size-preview" id="sizePreview">
        {%- comment -%} Shows garment + color + quantity {%- endcomment -%}
      </div>

      {%- comment -%} Quick Fill Templates {%- endcomment -%}
      <div class="quick-fill-section">
        <h4 class="quick-fill-title">Quick Fill</h4>
        <div class="quick-fill-buttons">
          <button type="button" class="button-secondary button-secondary--sm" data-action="quick-fill-even">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="2" y="6" width="3" height="8" stroke="currentColor" stroke-width="1.5"/>
              <rect x="6.5" y="6" width="3" height="8" stroke="currentColor" stroke-width="1.5"/>
              <rect x="11" y="6" width="3" height="8" stroke="currentColor" stroke-width="1.5"/>
            </svg>
            Even Split
          </button>
          <button type="button" class="button-secondary button-secondary--sm" data-action="quick-fill-typical">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="2" y="8" width="2" height="6" stroke="currentColor" stroke-width="1.5"/>
              <rect x="5.5" y="4" width="2" height="10" stroke="currentColor" stroke-width="1.5"/>
              <rect x="9" y="2" width="2" height="12" stroke="currentColor" stroke-width="1.5"/>
              <rect x="12.5" y="4" width="2" height="10" stroke="currentColor" stroke-width="1.5"/>
            </svg>
            Typical (Bell Curve)
          </button>
        </div>
      </div>

      {%- comment -%} Size Input Grid {%- endcomment -%}
      <div class="size-input-grid" id="sizeInputGrid">
        {%- comment -%} Dynamically populated based on quantity {%- endcomment -%}
      </div>

      <div class="size-total-row">
        <span class="size-total-label">Total:</span>
        <span class="size-total-value" id="sizeTotalValue">0 / 0</span>
      </div>

    </div>
    <div class="modal-footer">
      <button type="button" class="button-secondary" data-action="skip-size-distribution">Skip (distribute later)</button>
      <button type="button" class="button-primary" data-action="confirm-size-distribution">
        Confirm Distribution
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M5 10L8 13L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</div>

{%- comment -%} Copy to Other Garments Modal {%- endcomment -%}
<div class="modal-overlay" id="copyColorwayModal" style="display: none;">
  <div class="modal-container modal-container--md">
    <div class="modal-header">
      <h3 class="modal-title">Add This Color to Other Garments?</h3>
      <button type="button" class="modal-close" data-action="close-copy-modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">

      <div class="copy-preview" id="copyPreview">
        {%- comment -%} Shows the colorway just created {%- endcomment -%}
      </div>

      <p class="copy-help-text">Select garments to add this colorway to:</p>

      <div class="copy-garment-list" id="copyGarmentList">
        {%- comment -%} Checkboxes for other garments {%- endcomment -%}
      </div>

      <div class="form-field" id="copyQuantityField" style="display: none;">
        <label for="copyQuantity" class="form-field__label">
          Quantity for each selected garment
        </label>
        <input
          type="number"
          id="copyQuantity"
          class="form-field__input"
          placeholder="75"
          min="1"
          step="1"
        >
        <p class="form-field__help">Enter quantity (will use minimum if empty)</p>
      </div>

    </div>
    <div class="modal-footer">
      <button type="button" class="button-secondary" data-action="skip-copy-colorway">Skip</button>
      <button type="button" class="button-primary" data-action="confirm-copy-colorway">
        <span id="copyButtonText">Add to Selected</span>
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M5 10L8 13L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</div>

{%- comment -%} Pantone Color Studio Modal {%- endcomment -%}
{% render 'techpack-v11-color-studio-modal' %}

{%- comment -%} TechPack Color Picker (Native HTML5 color input) {%- endcomment -%}
<div class="modal-overlay" id="techpackColorModal" style="display: none;">
  <div class="modal-container modal-container--sm">
    <div class="modal-header">
      <h3 class="modal-title">Select Color from TechPack</h3>
      <button type="button" class="modal-close" data-action="close-techpack-color-modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="modal-help-text">
        Pick the approximate color from your TechPack for reference. We'll match it exactly from your uploaded files.
      </p>
      <div class="techpack-color-picker-wrapper">
        <input type="color" id="techpackColorPicker" class="techpack-color-picker" value="#000000">
        <div class="techpack-color-preview">
          <div class="techpack-color-preview__swatch" id="techpackColorSwatch" style="background-color: #000000;"></div>
          <div class="techpack-color-preview__info">
            <span class="techpack-color-preview__hex" id="techpackColorHex">#000000</span>
            <span class="techpack-color-preview__label">Color Reference</span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="button-secondary" data-action="close-techpack-color-modal">Cancel</button>
      <button type="button" class="button-primary" data-action="confirm-techpack-color">
        Continue
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  window.TECHPACK_V11_CUSTOMER = {
    isLoggedIn: {{ customer | json }} !== null
  };

  // Pantone color JSON URL (for Color Studio)
  window.TECHPACK_V11_PANTONE_URL = "{{ 'pantone-colors.json' | asset_url }}";
</script>

{% render 'techpack-v11-theme-switcher' %}

<script src="{{ 'techpack-v11-core.js' | asset_url }}" defer></script>
<script src="{{ 'techpack-v11-actions.js' | asset_url }}" defer></script>
<script src="{{ 'techpack-v11-bulk-step4.js' | asset_url }}" defer></script>
<script src="{{ 'techpack-v11-color-studio.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "TP V11 Bulk Step 4",
  "class": "section-techpack-v11-step",
  "settings": []
}
{% endschema %}
